<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition App</title>
    <link rel="stylesheet" href="css/app.css">
</head>
<body>
    <!-- Toast notifications container -->
    <div id="toast-container" class="toast-container" aria-live="polite" role="region"></div>

    <!-- Application Header -->
    <header class="app-header">
        <h1 class="app-header__title">Face Recognition App</h1>
    </header>

    <!-- Main Application Content -->
    <main class="app-main">
        <section class="status-indicator" aria-live="polite">
            <p class="status-indicator__text">Initializing service worker...</p>
            <progress class="status-indicator__progress" value="0" max="100"></progress>
        </section>

        <div class="navigation-buttons">
            <!-- Initially disabled until service worker is ready -->
            <button id="register-button" class="button button--primary" disabled>Register Face</button>
            <button id="verify-button" class="button button--secondary" disabled>Verify Face</button>
        </div>
    </main>

    <!-- Load scripts -->
    <script src="js/face-api.js"></script>
    <script type="module">
        import { updateStatus, showToast } from './js/modules/ui.js';

        // Get button elements
        const registerBtn = document.getElementById('register-button');
        const verifyBtn = document.getElementById('verify-button');

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Register the service worker
                await registerServiceWorker();
                
                // Enable navigation buttons
                registerBtn.disabled = false;
                verifyBtn.disabled = false;
                
                // Set up navigation buttons
                setupNavigation();
            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('Error: ' + error.message, 0);
                showToast('Failed to initialize application: ' + error.message, 'error');
            }
        });
        
        /**
         * Ensures the service worker is registered
         * @returns {Promise<void>}
         */
        async function registerServiceWorker() {
            updateStatus('Checking service worker...', 20);
            
            if ('serviceWorker' in navigator) {
                try {
                    // Check if service worker is already active
                    const existingReg = await navigator.serviceWorker.getRegistration();
                    
                    if (existingReg) {
                        console.log('Service Worker already registered');
                        updateStatus('Service worker already registered', 100);
                        return;
                    }
                    
                    // Register service worker if not already registered
                    const registration = await navigator.serviceWorker.register('./js/faceDetectionServiceWorker.js', {
                        scope: './'
                    });
                    console.log('Service Worker registered with scope:', registration.scope);
                    updateStatus('Service worker registered successfully', 100);
                    showToast('Service worker ready', 'success');
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                    throw new Error('Failed to register service worker: ' + error.message);
                }
            } else {
                throw new Error('Service Workers not supported in this browser');
            }
        }
        
        /**
         * Sets up navigation button click handlers
         */
        function setupNavigation() {
            registerBtn.addEventListener('click', () => {
                window.location.href = 'face_register.html';
            });
            
            verifyBtn.addEventListener('click', () => {
                window.location.href = 'verify_face.html';
            });
        }
    </script>
</body>
</html> 